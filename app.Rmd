---
title: "COVID-19: Contact tracing locations of interest"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    social: menu
runtime: shiny
---

```{r setup, include=FALSE}
library(shiny)
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(DT)
library(leaflet)


locations_of_interest <- 
 rgdal::readOGR("https://raw.githubusercontent.com/minhealthnz/nz-covid-data/main/locations-of-interest/august-2021/locations-of-interest.geojson") %>% 
 as_tibble()

locations_of_interest$Start_time <-
 as.POSIXct(locations_of_interest$Start,
            format = "%d/%m/%Y, %I:%M %p")
           
locations_of_interest$End_time <-
 as.POSIXct(locations_of_interest$End,
            format = "%d/%m/%Y, %I:%M %p")
                    
      
locations_of_interest$info <- paste0(
 "<H3>Event infomation</H3>",
 "<strong>Event</strong>: ",
 locations_of_interest$Event,
 "<br>",
 "<strong>Location</strong>: ",
 locations_of_interest$Location,
 "<br>",
 
 "<strong>City</strong>: ",
 locations_of_interest$City,
 "<br>",
 
 "<strong>Start date/time</strong>: ",
 locations_of_interest$Start,
 "<br>",
 
 "<strong>End date/time</strong>: ",
 locations_of_interest$End,
 "<br>",
 
 "<strong>Advice</strong>: ",
 locations_of_interest$Advice,
 "<br>"
)

locations_of_interest$Added_Date <- 
  ymd(sapply(strsplit(locations_of_interest$Added, " "), function(x) x[1]))

locations_of_interest$Added_Time <- 
  hms(sapply(strsplit(locations_of_interest$Added, " "), function(x) x[2]))

locations_of_interest$Added_Date[is.na(locations_of_interest$Added_Date)] <-
  min(locations_of_interest$Added_Date, na.rm = TRUE) - 1

```


Inputs {.sidebar}
-----------------------------------------------------------------------



```{r}

strong(p("Ministry of Health Data was last updated at", 
  max(locations_of_interest$Added_Date + locations_of_interest$Added_Time, na.rm = TRUE)))

strong(p("Note this map and table does not have information about public transort."))


selectInput(
  "added",
  label = h4("Date of new locations was added"),
  choices = c("All",
              as.character(sort(unique(locations_of_interest$Added_Date),
                decreasing = TRUE))),
  selected = "All"
)


selectInput(
  "city",
  label = h4("City"),
  choices = c("All", sort(unique(
    locations_of_interest$City
  ))),
  selected = "All"
)

renderUI({
  if (input$city != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(City == input$city)
  }
  
  if (input$added != "All") {
    locations_of_interest <-
      locations_of_interest  %>%
      filter(Added_Date == input$added)
  }
  
  
  selectInput(
    "start_time",
    label = h4("Event Start Date"),
    choices = c("All",
                as.character(sort(
                  unique(as.Date(locations_of_interest$Start_time)),
                  decreasing = TRUE
                ))),
    selected = "All"
  )
  
})


h4("Note:")
p(
  "Map and table are based from the data in the Ministry of Health's COVID-19: Contact tracing locations of interest in ",
  a("here",
    href = "https://www.health.govt.nz/our-work/diseases-and-conditions/covid-19-novel-coronavirus/covid-19-health-advice-public/contact-tracing-covid-19/covid-19-contact-tracing-locations-interest"),
  ", which is under the Ministry of Health's ",
  a("creative commons license",
    href = "https://www.health.govt.nz/about-site/copyright")
)


h4("Contact:")
h5(a("Kevin Chang", href = "mailto:kevin.ct.chang@gmail.com"))
p(
  "Source code can be founded in ",
  a("here",
    href = "https://github.com/kcha193/covid_locations")
)


```

Column {data-width=600}
-----------------------------------------------------------------------

### Locations of interest map


```{r}

renderLeaflet({
 
   if (input$city != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(City == input$city)
  }
  
  if (input$added != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(Added_Date == input$added)
  }
  

  if (input$start_time != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(as.Date(Start_time) == input$start_time)
  }
  
  
  locations_of_interest %>%
    leaflet() %>%
    addTiles() %>%
    addCircleMarkers(
      lng = ~ coords.x1,
      lat = ~ coords.x2,
      popup = ~ info
    )
})
```

Column {data-width=400}
-----------------------------------------------------------------------

### Locations of interest table

```{r}

renderDT({
  
  if (input$city != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(City == input$city)
  }
  
  if (input$added != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(Added_Date == input$added)
  }
  

  if (input$start_time != "All") {
    locations_of_interest <-
      locations_of_interest %>%
      filter(as.Date(Start_time) == input$start_time)
  }
  
  
  locations_of_interest %>% 
    select(Event:End) %>% 
    datatable(options = list( pageLength = 6))
  
})



```


